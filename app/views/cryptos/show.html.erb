<%= javascript_include_tag 'chart' %>
<%= javascript_include_tag 'timechoice' %>
<%= javascript_include_tag "https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js", defer: true %>

  <%= render 'shared/navbar'%>
<div class="container-body">
  <div class="chart-section">
    <p class="symbol" id="crypto-symbol"><%= @crypto.symbol %></p>
    
    
    <div role="button" id="btn-1m">
      <p>1m</p>
    </div>
    <div role="button" id="btn-15m">
      <p>15m</p>
    </div>
    <div role="button" id="btn-1h">
      <p>1h</p>
    </div>
    <div role="button" id="btn-4h">
      <p>4h</p>
    </div>

    <div role="button" id="btn-1d-main">
      <p id="time-label">1d</p>
      <div id="time-options">
        <button id="btn-6h">
          <p>6h</p>
        </button>
        <button id="btn-12h">
          <p>12h</p>
        </button>
        <button id="btn-1d">
          <p>1d</p>
        </button>
      </div>
    </div>

    <div id="chart"></div>

    <div class="vote-section">
      <% if user_signed_in? %>
        <% user_vote = current_user.votes.find_by(crypto: @crypto) %>
        <% if user_vote %>
          <p> Your Sentiment Price for <%= user_vote.created_at.utc.strftime('%H:%M UTC %B %d, %Y') %>: <%= user_vote.is_bullished ? "Bullish" : "Bearish" %></p>
        <% else %>
          <%= button_to "Bullish", crypto_votes_path(@crypto, is_bullished: true), method: :post, class: "btn btn-bullish" %>
          <%= button_to "Bearish", crypto_votes_path(@crypto, is_bullished: false), method: :post, class: "btn btn-bearish" %>
        <% end %>
      <% else %>
        <p>Veuillez <%= link_to "vous connecter", new_user_session_path %> pour voter.</p>
      <% end %>
    </div>


    </div>
  </div>

  <div class="post-section">
  <%= render "shared/flash" %>

    <div class="posts-container">
      <% @posts.each do |post| %>

        <!-- Post -->
        <div class="post-line">
          <p><%= time_ago_in_words(post.created_at) %> ago</p>
          <%= post.user.username %>
          <%= post.content %>
          <%= post.comments.size %>
          <% if post.user == current_user %>
            <%= button_to "Delete", post_path(post), method: :delete, data: { confirm: "Are you sure you want to delete this post?" }, class: "btn-delete-post" %>
          <% end %>
        </div>

        <!-- Comments of the post -->
        <div class="comments-container">
          <% if post.comments.any? %>
            <% post.comments.order(created_at: :desc).each do |comment| %>
              <div class="comment-line">
                <%= comment.user.username %>
                <%= comment.content %>
                <% if comment.user == current_user %>
                  <%= button_to "Delete", comment_path(comment), method: :delete, data: { confirm: "Are you sure you want to delete this comment?" }, class: "btn-delete-comment" %>
                <% end %>
              </div>
            <% end %>
          <% end %> 
        </div>
         
        <!-- Form to add new comment -->
        <% if user_signed_in? %>
          <div class="new-comment">
            <%= form_with model: [post, Comment.new], local: true do |form| %>
              <%= form.text_field :content, placeholder: "Your comment...", class: "form-control" %>
              <%= form.submit "Create", class: "btn-primary-add" %>
            <% end %> 
          </div>
        <% else %>
          <p>Please <%= link_to "log in", new_user_session_path %> to add a comment.</p>
        <% end %>
      
      <% end %>
    </div>
    
    <!-- Form to add a new post -->
    <% if user_signed_in? %>
      <div class="new-post">
        <%= form_with model: @post, url: crypto_posts_path(@crypto), local: true do |form| %>
          <%= form.text_field :content, placeholder: "Write a new post...", class: "form-control" %>
          <%= form.submit "Create", class: "btn-primary-add" %>
        <% end %>
      </div>
    <% else %>
      <p>Please <%= link_to "log in", new_user_session_path %> to create a post.</p>
    <% end %>

  </div>

</div>

